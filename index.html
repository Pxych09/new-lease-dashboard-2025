<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PB - Lease Management Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto">
    <h2 class="text-2xl font-bold mb-4">Lease Management Dashboard</h2>
    <div class="mb-4">
      <label for="sheetSelect" class="block text-sm font-medium text-gray-700">Select Sheet:</label>
      <select id="sheetSelect" class="mt-1 block w-full p-2 border rounded-md">
        <option value="">-- Select a Sheet --</option>
      </select>
    </div>
    <div id="loading" class="hidden text-gray-600">Loading...</div>
    <div id="error" class="hidden text-red-600"></div>
    <div id="dataTable" class="mt-4"></div>
  </div>

  <script>
    const scriptUrl = "https://script.google.com/macros/s/AKfycbx9BnScZXouEciOLKTy2Qs9FOx7gYvWXTb_XdmZqguehD4sUZmSjFLfsn75rIO9KGLBIQ/exec";
    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(scriptUrl)}`;

    async function loadSheets() {
      try {
        document.getElementById("loading").classList.remove("hidden");
        const response = await fetch(proxyUrl);
        const data = await response.json();

        // Check if contents is valid JSON
        let parsed;
        try {
          parsed = JSON.parse(data.contents);
        } catch (e) {
          throw new Error("Invalid JSON from server: " + data.contents.substring(0, 50));
        }

        if (!parsed.success) {
          throw new Error(parsed.message || "Failed to fetch sheets");
        }

        console.log("Sheets Data:", parsed);

        const select = document.getElementById("sheetSelect");
        select.innerHTML = '<option value="">-- Select a Sheet --</option>';
        parsed.sheetNames.forEach(name => {
          const option = document.createElement("option");
          option.value = name;
          option.textContent = name;
          select.appendChild(option);
        });

        select.addEventListener("change", loadSheetData);
      } catch (error) {
        document.getElementById("error").textContent = `Error: ${error.message}`;
        document.getElementById("error").classList.remove("hidden");
        console.error("Error fetching data:", error);
      } finally {
        document.getElementById("loading").classList.add("hidden");
      }
    }

    async function loadSheetData(event) {
      const sheetName = event.target.value;
      if (!sheetName) return;

      try {
        document.getElementById("loading").classList.remove("hidden");
        document.getElementById("dataTable").innerHTML = "";
        document.getElementById("error").classList.add("hidden");

        const response = await fetch(scriptUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sheetName }),
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.message || "Failed to fetch sheet data");
        }

        console.log("Sheet Data:", data);

        // Render data as a table
        const table = document.createElement("table");
        table.className = "min-w-full bg-white border rounded-md";
        const thead = document.createElement("thead");
        const tbody = document.createElement("tbody");

        // Add headers (first row)
        const headerRow = document.createElement("tr");
        data.data[0].forEach(cell => {
          const th = document.createElement("th");
          th.textContent = cell;
          th.className = "border px-4 py-2 bg-gray-200";
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);

        // Add data rows
        data.data.slice(1).forEach(row => {
          const tr = document.createElement("tr");
          row.forEach(cell => {
            const td = document.createElement("td");
            td.textContent = cell;
            td.className = "border px-4 py-2";
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });

        table.appendChild(thead);
        table.appendChild(tbody);
        document.getElementById("dataTable").appendChild(table);

        // Optional: Render a bar chart (uncomment to enable)
        /*
        const headers = data.data[0]; // e.g., ["Month", "Revenue"]
        const rows = data.data.slice(1); // e.g., [["Jan", 1000], ["Feb", 2000]]
        const labels = rows.map(row => row[0]); // e.g., ["Jan", "Feb"]
        const values = rows.map(row => Number(row[1])); // e.g., [1000, 2000]

        const canvas = document.createElement("canvas");
        canvas.id = "chart";
        document.getElementById("dataTable").appendChild(canvas);

        new Chart(canvas, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [{
              label: headers[1],
              data: values,
              backgroundColor: "rgba(59, 130, 246, 0.5)",
              borderColor: "rgba(59, 130, 246, 1)",
              borderWidth: 1,
            }],
          },
          options: {
            scales: {
              y: { beginAtZero: true },
            },
          },
        });
        */
      } catch (error) {
        document.getElementById("error").textContent = `Error: ${error.message}`;
        document.getElementById("error").classList.remove("hidden");
        console.error("Error fetching sheet data:", error);
      } finally {
        document.getElementById("loading").classList.add("hidden");
      }
    }

    window.onload = loadSheets;
  </script>
</body>
</html>
